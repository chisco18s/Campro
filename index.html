<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <title>SPECTRAL AI v12 - PRO EVP</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
    <style>
        :root { --main: #00f2ff; --danger: #ff004c; --ui: var(--main); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Courier New', monospace; }
        body { background: #000; color: white; overflow: hidden; }

        #video { position: absolute; width: 100%; height: 100%; object-fit: cover; z-index: 1; opacity: 0.4; transition: 0.3s; }
        #canvas { position: absolute; width: 100%; height: 100%; z-index: 5; pointer-events: none; }

        /* HUD Superior Din√°mico */
        .hud-top {
            position: absolute; top: 0; width: 100%; padding: 45px 20px 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            display: grid; grid-template-columns: 1fr 1fr 1fr; z-index: 10;
            border-bottom: 1px solid var(--ui);
        }
        .stat { font-size: 9px; color: var(--ui); display: block; }
        .val { font-size: 14px; font-weight: bold; }

        /* Visualizador de Audio (Psicofon√≠a) */
        #evp-container {
            position: absolute; top: 130px; left: 50%; transform: translateX(-50%);
            width: 90%; background: rgba(0,0,0,0.7); border: 1px solid var(--ui);
            padding: 10px; z-index: 10; text-align: center;
        }
        #audio-visualizer { width: 100%; height: 40px; background: #000; margin-bottom: 5px; }
        #evp-word { 
            font-size: 22px; color: #fff; font-style: italic; font-weight: bold;
            text-shadow: 0 0 10px var(--ui); min-height: 28px;
        }

        /* Registro de Eventos */
        #log {
            position: absolute; bottom: 100px; left: 20px; width: 200px;
            font-size: 9px; color: var(--ui); z-index: 10; pointer-events: none;
        }

        /* UI de Control */
        .ui-controls {
            position: absolute; bottom: 30px; width: 100%;
            display: flex; justify-content: center; gap: 10px; z-index: 20;
        }
        button {
            background: rgba(0,0,0,0.8); border: 1px solid var(--ui);
            color: var(--ui); padding: 12px 18px; border-radius: 4px;
            font-size: 9px; cursor: pointer;
        }
        button.active { background: var(--ui); color: #000; box-shadow: 0 0 10px var(--ui); }

        .glitch-red { animation: flash 0.2s infinite; }
        @keyframes flash { 0% { opacity: 0.5; } 50% { opacity: 1; color: red; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="hud-top">
        <div><span class="stat">EMF_SENS</span><span id="emf" class="val">0.00</span></div>
        <div style="text-align:center"><span class="stat">DB_LEVEL</span><span id="db-lvl" class="val">-Inf</span></div>
        <div style="text-align:right"><span class="stat">SIGNAL</span><span id="threat" class="val">SCANNING</span></div>
    </div>

    <div id="evp-container">
        <canvas id="audio-visualizer"></canvas>
        <div id="evp-word">CALIBRANDO...</div>
    </div>

    <div id="log"></div>

    <video id="video" playsinline muted></video>
    <canvas id="canvas"></canvas>

    <div class="ui-controls">
        <button id="btn-camera">üîÑ C√ÅMARA</button>
        <button id="btn-ghost">üëª GHOST</button>
        <button id="btn-rec" class="active">‚è∫ EVP ACTIVE</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const audioCanvas = document.getElementById('audio-visualizer');
        const actx = audioCanvas.getContext('2d');
        
        let poseDetector;
        let isGhost = false;
        let currentFacing = 'environment';
        let activeEntity = null;
        let audioCtx, analyser, dataArray;

        const EVP_LIBRARY = ["AY√öDAME", "NO TE VAYAS", "AQU√ç ESTOY", "SOLO", "FR√çO", "ESC√öCHAME", "LARGO", "MORIR", "VETE"];

        async function init() {
            poseDetector = new Pose({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}` });
            poseDetector.setOptions({ modelComplexity: 0, smoothLandmarks: true, minDetectionConfidence: 0.6 });
            poseDetector.onResults(onResults);
            
            await setupCamera();
            setupAudio();

            const frameLoop = async () => {
                if (video.readyState >= 2) await poseDetector.send({ image: video });
                drawAudioWave();
                requestAnimationFrame(frameLoop);
            };
            frameLoop();
        }

        async function setupCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: currentFacing, width: { ideal: 640 } }
            });
            video.srcObject = stream;
            video.play();
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            };
        }

        function setupAudio() {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                setInterval(processEVP, 2500); // Intento de psicofon√≠a cada 2.5s
            });
        }

        function drawAudioWave() {
            if (!analyser) return;
            analyser.getByteFrequencyData(dataArray);
            actx.clearRect(0, 0, audioCanvas.width, audioCanvas.height);
            actx.strokeStyle = document.documentElement.style.getPropertyValue('--ui') || '#00f2ff';
            actx.beginPath();
            let sliceWidth = audioCanvas.width / dataArray.length;
            let x = 0;
            for (let i = 0; i < dataArray.length; i++) {
                let v = dataArray[i] / 128.0;
                let y = v * audioCanvas.height / 2;
                if (i === 0) actx.moveTo(x, y); else actx.lineTo(x, y);
                x += sliceWidth;
            }
            actx.stroke();
            
            let sum = dataArray.reduce((a, b) => a + b, 0);
            let avg = sum / dataArray.length;
            document.getElementById('db-lvl').innerText = Math.floor(avg) + " dB";
            document.getElementById('emf').innerText = (activeEntity ? 55 + (avg/2) : avg/3).toFixed(2);
        }

        function processEVP() {
            if (!analyser) return;
            let sum = dataArray.reduce((a, b) => a + b, 0);
            let avg = sum / dataArray.length;

            // Si hay ruido ambiente o una entidad, hay m√°s probabilidad
            if ((avg > 35 || activeEntity) && Math.random() > 0.7) {
                const word = EVP_LIBRARY[Math.floor(Math.random() * EVP_LIBRARY.length)];
                document.getElementById('evp-word').innerText = word;
                document.getElementById('evp-word').classList.add('glitch-red');
                speakParanormal(word);
                addLog(`EVP: ${word}`);
                setTimeout(() => {
                    document.getElementById('evp-word').innerText = "ESCUCHANDO...";
                    document.getElementById('evp-word').classList.remove('glitch-red');
                }, 2000);
            }
        }

        function speakParanormal(text) {
            const ut = new SpeechSynthesisUtterance(text);
            ut.pitch = 0.1; // S√∫per grave
            ut.rate = 0.5;  // S√∫per lento
            ut.volume = 0.8;
            window.speechSynthesis.speak(ut);
        }

        function onResults(res) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (res.poseLandmarks) {
                if (!activeEntity) {
                    activeEntity = { id: "E-" + Math.floor(Math.random()*999) };
                    document.documentElement.style.setProperty('--ui', 'var(--danger)');
                    navigator.vibrate([100, 200]);
                }
                drawSkeleton(res.poseLandmarks);
                document.getElementById('threat').innerText = "IDENTIFICADO";
            } else {
                if (activeEntity) {
                    activeEntity = null;
                    document.documentElement.style.setProperty('--ui', 'var(--main)');
                    document.getElementById('threat').innerText = "SCANNING";
                }
            }
        }

        function drawSkeleton(lm) {
            ctx.fillStyle = "rgba(255, 0, 76, 0.2)";
            ctx.strokeStyle = "white";
            ctx.lineWidth = 1;
            
            // Cuerpo S√≥lido
            ctx.beginPath();
            [0, 12, 24, 28, 27, 23, 11].forEach((i, idx) => {
                const x = lm[i].x * canvas.width;
                const y = lm[i].y * canvas.height;
                if (idx === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.closePath(); ctx.fill(); ctx.stroke();

            // Puntos Anat√≥micos
            const parts = ["CABEZA", "HOMBRO_L", "HOMBRO_R", "CADERA_L", "CADERA_R"];
            const indices = [0, 11, 12, 23, 24];
            indices.forEach((idx, i) => {
                const p = lm[idx];
                ctx.fillStyle = "white";
                ctx.fillText(parts[i], p.x * canvas.width + 5, p.y * canvas.height);
                ctx.fillRect(p.x * canvas.width - 2, p.y * canvas.height - 2, 4, 4);
            });
        }

        function addLog(m) {
            const l = document.getElementById('log');
            l.innerHTML = `[${new Date().toLocaleTimeString()}] ${m}<br>` + l.innerHTML;
        }

        document.getElementById('btn-camera').onclick = () => {
            currentFacing = (currentFacing === 'user') ? 'environment' : 'user';
            setupCamera();
        };

        document.getElementById('btn-ghost').onclick = function() {
            isGhost = !isGhost;
            video.style.opacity = isGhost ? "0.05" : "0.4";
            this.classList.toggle('active');
        };

        init();
    </script>
</body>
</html>


